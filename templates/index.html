<!DOCTYPE html>
<html lang="ja">
  <head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DJ1GBY3Z78"></script>
  <script>
       window.dataLayer = window.dataLayer || [];
       function gtag(){dataLayer.push(arguments);}
       gtag('js', new Date());

       gtag('config', 'G-DJ1GBY3Z78');
    </script>
    <meta charset="UTF-8" />
    <title>北海道ヒグマ出没マップ / Hokkaido Bear Encounter Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      :root { color-scheme: dark; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        background: #050608;
        color: #f5f5f5;
      }
      header {
        background: radial-gradient(circle at left, #1f4068, #050608 60%);
        padding: 10px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .title-block { display: flex; flex-direction: column; }
      .title-main { font-size: 1.15rem; font-weight: 700; }
      .title-sub { font-size: 0.8rem; color: #cfd8dc; }
      .pill {
        font-size: 0.7rem;
        padding: 3px 8px;
        margin-left: 6px;
        background: rgba(144, 202, 249, 0.18);
        border-radius: 999px;
        border: 1px solid rgba(144, 202, 249, 0.5);
      }
      .header-right { display: flex; gap: 6px; }
      .btn {
        font-size: 0.75rem;
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.05);
        cursor: pointer;
        color: #fff;
      }
      .layout {
        display: grid;
        grid-template-columns: 3fr 1.2fr;
        gap: 10px;
        padding: 10px;
      }
      @media (max-width: 900px) {
        .layout { grid-template-columns: 1fr; }
        #map { height: 50vh; }
        .side-panel { height: auto; }
      }
      #map {
        width: 100%;
        height: calc(100vh - 90px);
        border-radius: 12px;
        box-shadow: 0 0 18px rgba(0,0,0,0.7);
      }
      .side-panel {
        height: calc(100vh - 90px);
        overflow-y: auto;
        padding: 10px;
        background: radial-gradient(circle at top, #14191f, #050608 65%);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.08);
      }
      .side-section {
        margin-bottom: 14px;
        font-size: 0.82rem;
      }
      .side-section h2 {
        font-size: 0.9rem;
        margin-bottom: 4px;
        border-left: 3px solid #90caf9;
        padding-left: 6px;
      }
      .legend-row { 
        display: flex; 
        gap: 6px; 
        align-items: center; 
      }
      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
      }
      .legend-dot.day {
        background: #ffeb3b;
        box-shadow: 0 0 6px rgba(255,235,59,0.7);
      }
      .legend-dot.night {
        background: #80d8ff;
        box-shadow: 0 0 6px rgba(128,216,255,0.7);
      }
      .legend-color {
        width: 18px;
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(to right, #1e88e5, #ffb300, #e53935);
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }
      .stat-card {
        background: rgba(0,0,0,0.35);
        border-radius: 8px;
        padding: 4px 6px;
        border: 1px solid rgba(255,255,255,0.08);
      }
      .stat-label { font-size: 0.7rem; color: #b0bec5; }
      .stat-value { font-size: 0.95rem; font-weight: 600; }
      .ward-line {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px dashed rgba(255,255,255,0.06);
        padding: 2px 0;
        font-size: 0.78rem;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title-block">
        <div class="title-main" id="title-main">
          北海道ヒグマ遭遇リスクマップ<span class="pill">行動解析ビュー</span>
        </div>
        <div class="title-sub" id="title-sub">
          Esri 高解像度画像 × 札幌市出没データ × 昼夜・月別ヒートマップ
        </div>
      </div>
      <div class="header-right">
        <button class="btn" id="lang-ja">日本語</button>
        <button class="btn" id="lang-en">English</button>
      </div>
    </header>

    <div class="layout">
      <div id="map"></div>

      <aside class="side-panel">
        <div class="side-section">
          <h2 id="about-title">このマップについて</h2>
          <p id="about-text">
            北海道・札幌周辺で記録されたヒグマ出没データをもとに、
            出没地点分布と昼夜・月別の行動パターンを可視化しています。
            背景には Esri の高解像度衛星・航空画像を使用しています。
          </p>
          <div class="legend-row">
            <span class="legend-dot day"></span><span id="legend-day-text">昼の出没</span>
          </div>
          <div class="legend-row">
            <span class="legend-dot night"></span><span id="legend-night-text">夜の出没</span>
          </div>
          <div class="legend-row" style="margin-top:4px;">
            <span class="legend-color"></span>
            <span id="legend-heat-text">青→黄→赤：出没密度が高いエリア</span>
          </div>
        </div>

        <div class="side-section">
          <h2 id="period-title">データ期間</h2>
          <div id="date-range" style="font-size:0.85rem; color:#cfd8dc;">読み込み中…</div>
        </div>

        <div class="side-section">
          <h2 id="summary-title">出没件数サマリ</h2>
          <div id="summary"></div>
        </div>

        <div class="side-section">
          <h2 id="ward-title">よく出るエリア（区別集計）</h2>
          <div id="ward-summary"></div>
        </div>

        <div class="side-section">
          <h2 id="heatmap-title">ヒートマップの見方</h2>
          <p id="heatmap-text">
            レイヤーコントロール（地図左上）から、
            「総合」「昼のみ」「夜のみ」のヒートマップ、
            さらに月別（4月・5月・6月…）を切り替えられます。
            川沿いの緑地帯や、住宅地ギリギリの森林縁などに
            赤いゾーンが集まっていないか確認してみてください。
          </p>
        </div>

        <div class="side-section">
          <h2 id="hint-title">解析のヒント</h2>
          <ul>
            <li id="hint-1">河川沿いの緑地に沿って出没が並んでいないか</li>
            <li id="hint-2">住宅地ギリギリの森林縁で出没が多くないか</li>
            <li id="hint-3">昼と夜で行動圏が変わっていないか</li>
          </ul>
        </div>
      </aside>
    </div>

    <!-- Leaflet JS & Heat -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
      /* =========================
         多言語 UI（本文）辞書
      ========================== */
      const dict = {
        ja: {
          title_main: "北海道ヒグマ遭遇リスクマップ",
          title_sub:
            "Esri 高解像度画像 × 札幌市出没データ × 昼夜・月別ヒートマップ",
          about_title: "このマップについて",
          about_text:
            "北海道・札幌周辺で記録されたヒグマ出没データをもとに、出没地点分布と昼夜・月別の行動パターンを可視化しています。背景には Esri の高解像度衛星・航空画像を使用しています。",
          legend_day: "昼の出没",
          legend_night: "夜の出没",
          legend_heat: "青→黄→赤：出没密度が高いエリア",
          period_title: "データ期間",
          summary_title: "出没件数サマリ",
          ward_title: "よく出るエリア",
          heatmap_title: "ヒートマップの見方",
          heatmap_text:
            "レイヤーコントロール（地図左上）から、「総合」「昼のみ」「夜のみ」のヒートマップ、さらに月別（4月・5月・6月…）を切り替えられます。",
          hint_title: "解析のヒント",
          hint_1: "河川沿いの緑地に沿って出没が並んでいないか",
          hint_2: "住宅地ギリギリの森林縁で出没が多くないか",
          hint_3: "昼と夜で行動圏が変わっていないか",
        },
        en: {
          title_main: "Hokkaido Bear Encounter Risk Map",
          title_sub:
            "Esri High-Resolution Imagery × Sapporo Bear Records × Day/Night & Monthly Heatmaps",
          about_title: "About This Map",
          about_text:
            "This map visualizes bear sightings recorded around Sapporo, showing day/night patterns and monthly changes. High-resolution Esri aerial & satellite imagery is used as the base.",
          legend_day: "Daytime sightings",
          legend_night: "Nighttime sightings",
          legend_heat: "Blue → Yellow → Red: higher encounter density",
          period_title: "Data Coverage",
          summary_title: "Sightings Summary",
          ward_title: "Frequent Sightings",
          heatmap_title: "How to Use the Heatmaps",
          heatmap_text:
            "Use the layer control (top-left) to toggle overall, daytime-only, nighttime-only, and monthly heatmaps.",
          hint_title: "Interpretation Tips",
          hint_1: "Watch for clusters following river corridors",
          hint_2: "Check forest edges near houses",
          hint_3: "Compare daytime vs nighttime zones",
        },
      };

      function switchLang(lang) {
        const t = dict[lang];
        document.getElementById("title-main").textContent = t.title_main;
        document.getElementById("title-sub").textContent = t.title_sub;
        document.getElementById("about-title").textContent = t.about_title;
        document.getElementById("about-text").textContent = t.about_text;
        document.getElementById("legend-day-text").textContent = t.legend_day;
        document.getElementById("legend-night-text").textContent =
          t.legend_night;
        document.getElementById("legend-heat-text").textContent =
          t.legend_heat;
        document.getElementById("period-title").textContent = t.period_title;
        document.getElementById("summary-title").textContent =
          t.summary_title;
        document.getElementById("ward-title").textContent = t.ward_title;
        document.getElementById("heatmap-title").textContent =
          t.heatmap_title;
        document.getElementById("heatmap-text").textContent =
          t.heatmap_text;
        document.getElementById("hint-title").textContent = t.hint_title;
        document.getElementById("hint-1").textContent = t.hint_1;
        document.getElementById("hint-2").textContent = t.hint_2;
        document.getElementById("hint-3").textContent = t.hint_3;
      }

      /* =========================
         レイヤー名辞書（日本語 / 英語）
      ========================== */
      const layerNameDict = {
        ja: {
          base: { esri: "Esri 衛星画像" },
          overlays: {
            points: "出没ポイント",
            all: "ヒートマップ（総合）",
            day: "ヒートマップ（昼のみ）",
            night: "ヒートマップ（夜のみ）",
            month: (m) => `ヒートマップ（${m}月）`,
          },
        },
        en: {
          base: { esri: "Esri World Imagery" },
          overlays: {
            points: "Bear Points",
            all: "Heatmap (All)",
            day: "Heatmap (Daytime)",
            night: "Heatmap (Nighttime)",
            month: (m) =>
              `Heatmap (${[
                "Jan","Feb","Mar","Apr","May","Jun",
                "Jul","Aug","Sep","Oct","Nov","Dec"
              ][m - 1]})`,
          },
        },
      };

      let pointLayer = null;
      let heatAll = null;
      let heatDay = null;
      let heatNight = null;
      const heatMonthly = {};

      let layerControl = null;

      function rebuildLayerControl(lang) {
        if (layerControl) map.removeControl(layerControl);

        const baseDict = layerNameDict[lang].base;
        const ovDict = layerNameDict[lang].overlays;

        const baseLayers = {};
        baseLayers[baseDict.esri] = esri;

        const overlays = {};
        if (pointLayer) overlays[ovDict.points] = pointLayer;
        if (heatAll) overlays[ovDict.all] = heatAll;
        if (heatDay) overlays[ovDict.day] = heatDay;
        if (heatNight) overlays[ovDict.night] = heatNight;

        Object.keys(heatMonthly).forEach((mStr) => {
          const m = parseInt(mStr, 10);
          overlays[ovDict.month(m)] = heatMonthly[m];
        });

        layerControl = L.control.layers(baseLayers, overlays);
        layerControl.addTo(map);
      }

      // 言語切替ボタン連動
      document.getElementById("lang-ja").onclick = () => {
        switchLang("ja");
        rebuildLayerControl("ja");
      };
      document.getElementById("lang-en").onclick = () => {
        switchLang("en");
        rebuildLayerControl("en");
      };

      // 初期言語
      switchLang("ja");

      /* =========================
         Leaflet 初期化
      ========================== */
      const map = L.map("map", { minZoom: 5, maxZoom: 18 }).setView(
        [43.06, 141.35],
        11
      );

      const esri = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 18,
          attribution: "Tiles © Esri",
        }
      ).addTo(map);
      /* =========================
         日付・時刻パース関数
      ========================== */
      function parseMonth(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split(/[\/\-]/);
        if (parts.length < 2) return null;
        const m = parseInt(parts[1], 10);
        return isNaN(m) ? null : m;
      }

      function parseHour(timeStr) {
        if (!timeStr) return null;
        const parts = timeStr.split(":");
        const h = parseInt(parts[0], 10);
        return isNaN(h) ? null : h;
      }

      /* =========================
         サイドバー表示
      ========================== */
      function renderDateRange(points) {
        const div = document.getElementById("date-range");
        if (!points.length) {
          div.textContent = "データなし";
          return;
        }
        let minT = Infinity, maxT = -Infinity;
        let minStr = "", maxStr = "";

        points.forEach((p) => {
          const [y, m, d] = (p.date || "").split(/[\/\-]/).map(Number);
          if (!y || !m || !d) return;
          const t = new Date(y, m - 1, d).getTime();
          if (t < minT) { minT = t; minStr = p.date; }
          if (t > maxT) { maxT = t; maxStr = p.date; }
        });

        div.textContent = `${minStr} 〜 ${maxStr}`;
      }

      function renderSummary(points) {
        const box = document.getElementById("summary");
        if (!points.length) {
          box.textContent = "データなし";
          return;
        }
        let day = 0, night = 0;

        points.forEach((p) => {
          const h = parseHour(p.time);
          if (h === null) return;
          if (h >= 5 && h < 18) day++; else night++;
        });

        box.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">総件数</div>
              <div class="stat-value">${points.length}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">昼</div>
              <div class="stat-value" style="color:#ffeb3b;">${day}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">夜</div>
              <div class="stat-value" style="color:#80d8ff;">${night}</div>
            </div>
          </div>
        `;
      }

      function renderWardSummary(points) {
        const box = document.getElementById("ward-summary");
        if (!points.length) {
          box.textContent = "データなし";
          return;
        }
        const count = {};
        points.forEach((p) => {
          const w = p.ward || "不明";
          count[w] = (count[w] || 0) + 1;
        });
        const entries = Object.entries(count).sort((a,b)=>b[1]-a[1]);

        box.innerHTML = "";
        entries.forEach(([ward, num]) => {
          box.innerHTML += `
            <div class="ward-line">
              <span>${ward}</span><span>${num}件</span>
            </div>
          `;
        });
      }

      /* =========================
         データ取得とヒートマップ生成
      ========================== */
      fetch("/api/points")
        .then((res) => res.json())
        .then((data) => {
          const points = data.points || [];

          renderDateRange(points);
          renderSummary(points);
          renderWardSummary(points);

          pointLayer = L.layerGroup();
          const allPts = [];
          const dayPts = [];
          const nightPts = [];
          const monthlyPts = {};

          points.forEach((p) => {
            const lat = p.lat;
            const lng = p.lng;

            // ========== マーカー ==========
            const marker = L.circleMarker([lat, lng], {
              radius: 4,
              color: "#fff",
              fillColor: "#fff",
              fillOpacity: 0.7,
              weight: 0.6,
            }).bindPopup(
              `<b>${p.date || ""} ${p.time || ""}</b><br>
               ${p.ward || ""}<br>
               ${p.place || ""}<br>
               <small>${p.status || ""}</small>`
            );

            pointLayer.addLayer(marker);

            // ========== ヒートマップ分類 ==========
            const h = parseHour(p.time);
            const isDay = h !== null ? (h >= 5 && h < 18) : false;

            allPts.push([lat, lng, 0.8]);
            if (isDay) dayPts.push([lat, lng, 0.8]);
            else nightPts.push([lat, lng, 0.8]);

            const m = parseMonth(p.date);
            if (m) {
              if (!monthlyPts[m]) monthlyPts[m] = [];
              monthlyPts[m].push([lat, lng, 0.8]);
            }
          });

          // ========== ヒートマップ生成 ==========
          const heatOptions = {
            radius: 34,
            blur: 22,
            maxZoom: 18,
            minOpacity: 0.35,
            gradient: {
              0.0: "#1e88e5",
              0.4: "#ffb300",
              0.7: "#f4511e",
              1.0: "#e53935",
            },
          };

          heatAll = L.heatLayer(allPts, heatOptions).addTo(map);
          heatDay = L.heatLayer(dayPts, heatOptions);
          heatNight = L.heatLayer(nightPts, heatOptions);

          Object.keys(monthlyPts).forEach((m) => {
            heatMonthly[m] = L.heatLayer(monthlyPts[m], heatOptions);
          });

          // ========== 初期レイヤー構築 ==========
          rebuildLayerControl("ja");
          pointLayer.addTo(map);
        })
        .catch((e) => {
          console.error("Error:", e);
          document.getElementById("date-range").textContent =
            "データ読み込みエラー";
        });
    </script>
  <p style="
    text-align:center;
    font-size:0.75em;
    color:#aaa;
    margin-top:2em;
    line-height:1.5;
  ">
    This project is independently maintained on a non-commercial basis.<br>
    Optional support helps keep the data updated and publicly available.
  </p>

  <p style="text-align:center; margin-top: 0.8em; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
    <a href="https://totonoesekkeishitsu.com/"
       style="padding:0.6em 1.5em; background:#555; color:#fff; border-radius:9999px; text-decoration:none;">
       About the Creator
    </a>

    <a href="https://www.buymeacoffee.com/totonoestudio"
       target="_blank" rel="noopener"
       style="padding:0.6em 1.5em; background:#ffdd00; color:#111; border-radius:9999px; text-decoration:none; font-weight:600;">
       ☕ Buy Me a Coffee
    </a>
  </p>

  <!-- フッター -->

  <footer style="text-align:center; font-size:0.75em; color:#777; padding:2em 0; border-top:1px solid #ccc; margin-top:3em;">
     ©2026 Totonoe Studio
  </footer>
  </body>
</html>
